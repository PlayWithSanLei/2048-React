# 2048 游戏单元测试用例文档

## 测试概述

本文档定义了 2048 游戏项目的单元测试用例，涵盖核心游戏逻辑、存储工具和 React Hook 等模块。

## 测试框架

- **测试框架**: Vitest
- **断言库**: Vitest 内置
- **覆盖率工具**: @vitest/coverage-v8
- **DOM 环境**: happy-dom
- **React 测试**: @testing-library/react

---

## 一、gameLogic.ts 测试用例

### 1.1 getEmptyGrid()

**功能描述**: 创建一个 4x4 的空网格

| 测试用例 ID | 测试场景 | 预期结果 |
|------------|---------|---------|
| GL-001 | 调用函数 | 返回 4x4 二维数组，所有元素为 null |
| GL-002 | 验证网格尺寸 | 第一维长度为 4，第二维长度为 4 |

---

### 1.2 getEmptyCells()

**功能描述**: 获取网格中所有空单元格的位置

| 测试用例 ID | 测试场景 | 输入 | 预期结果 |
|------------|---------|------|---------|
| GL-003 | 完全空网格 | 4x4 全 null 网格 | 返回 16 个位置 |
| GL-004 | 部分填充网格 | 中心位置有方块 | 返回排除中心位置的 15 个位置 |
| GL-005 | 完全填充网格 | 4x4 全有方块 | 返回空数组 |
| GL-006 | 单个方块网格 | 只有一个方块 | 返回 15 个位置 |

---

### 1.3 arePositionsEqual()

**功能描述**: 比较两个位置是否相等

| 测试用例 ID | 测试场景 | 输入 | 预期结果 |
|------------|---------|------|---------|
| GL-007 | 相同位置 | {x:0, y:0}, {x:0, y:0} | true |
| GL-008 | 不同 X 坐标 | {x:0, y:0}, {x:1, y:0} | false |
| GL-009 | 不同 Y 坐标 | {x:0, y:0}, {x:0, y:1} | false |
| GL-010 | 完全不同位置 | {x:1, y:2}, {x:3, y:3} | false |

---

### 1.4 generateRandomTile()

**功能描述**: 在空网格中生成一个随机方块

| 测试用例 ID | 测试场景 | 输入 | 预期结果 |
|------------|---------|------|---------|
| GL-011 | 空网格生成 | 4x4 全 null 网格 | 返回 Tile 对象，position 有效，value 为 2 或 4 |
| GL-012 | 方块值概率分布 | 多次生成 | 约 90% 为 2，10% 为 4 |
| GL-013 | 新方块标记 | 空网格 | isNew 属性为 true |
| GL-014 | 唯一 ID | 连续生成 | 每个 Tile 有唯一的 id |
| GL-015 | 满网格生成 | 4x4 全有方块 | 返回 null |

---

### 1.5 hasMoves()

**功能描述**: 检查游戏是否还有可用的移动

| 测试用例 ID | 测试场景 | 输入 | 预期结果 |
|------------|---------|------|---------|
| GL-016 | 空网格 | tiles 数量为 0 | true |
| GL-017 | 未满网格 | tiles 数量 < 16 | true |
| GL-018 | 满网格且有相邻相同值 | 4 个相同值相邻 | true |
| GL-019 | 满网格水平相邻相同 | 同一行有相邻相同值 | true |
| GL-020 | 满网格垂直相邻相同 | 同一列有相邻相同值 | true |
| GL-021 | 满网格无任何可移动 | 所有值不同且不相邻 | false |

---

### 1.6 move() - 向左移动

**功能描述**: 方块向左移动并合并

| 测试用例 ID | 测试场景 | 输入 | 预期结果 |
|------------|---------|------|---------|
| GL-022 | 单个方块左移 | 位置 (2,0) 的值为 2 | 方块移到 (0,0)，moved 为 true |
| GL-023 | 两个相同值合并 | (0,0)=2, (1,0)=2 | 合并为 4，位置 (0,0)，scoreIncrease=4 |
| GL-024 | 三个相同值合并 | (0,0)=2, (1,0)=2, (2,0)=2 | 前两个合并为 4，第三个保持为 2 |
| GL-025 | 四个相同值合并 | 四个 2 | 合并为两个 4 |
| GL-026 | 不同值不合并 | (0,0)=2, (1,0)=4 | 分别移到 (0,0) 和 (1,0) |
| GL-027 | 合并标记正确 | 合并操作 | mergedFrom 包含两个源 Tile |
| GL-028 | 已在左侧不移动 | (0,0)=2 | moved 为 false |
| GL-029 | 复杂合并场景 | (0,0)=2, (1,0)=2, (2,0)=4, (3,0)=4 | 结果为两个 4，位置 (0,0) 和 (1,0) |

---

### 1.7 move() - 向右移动

| 测试用例 ID | 测试场景 | 输入 | 预期结果 |
|------------|---------|------|---------|
| GL-030 | 单个方块右移 | 位置 (0,0) 的值为 2 | 方块移到 (3,0)，moved 为 true |
| GL-031 | 右侧合并 | (2,0)=2, (3,0)=2 | 合并为 4，位置 (3,0) |

---

### 1.8 move() - 向上移动

| 测试用例 ID | 测试场景 | 输入 | 预期结果 |
|------------|---------|------|---------|
| GL-032 | 单个方块上移 | 位置 (0,2) 的值为 2 | 方块移到 (0,0)，moved 为 true |
| GL-033 | 上方合并 | (0,0)=2, (0,1)=2 | 合并为 4，位置 (0,0) |

---

### 1.9 move() - 向下移动

| 测试用例 ID | 测试场景 | 输入 | 预期结果 |
|------------|---------|------|---------|
| GL-034 | 单个方块下移 | 位置 (0,0) 的值为 2 | 方块移到 (0,3)，moved 为 true |
| GL-035 | 下方合并 | (0,2)=2, (0,3)=2 | 合并为 4，位置 (0,3) |

---

### 1.10 移动边界测试

| 测试用例 ID | 测试场景 | 输入 | 预期结果 |
|------------|---------|------|---------|
| GL-036 | 空网格移动 | 空 tiles 数组 | tiles 保持为空，moved 为 false |
| GL-037 | 单行多种值 | 2, 2, 4, 4 | 正确合并为 4, 8 |
| GL-038 | 合并分数计算 | 合并产生 8 和 16 | scoreIncrease = 24 |
| GL-039 | 合并后状态清理 | 合并操作 | 源 Tile 的 isNew 和 mergedFrom 被清除 |

---

## 二、storage.ts 测试用例

### 2.1 getBestScore() / setBestScore()

**功能描述**: 最佳分数的存储和读取

| 测试用例 ID | 测试场景 | 输入 | 预期结果 |
|------------|---------|------|---------|
| ST-001 | 初始状态 | 无存储数据 | 返回 0 |
| ST-002 | 保存并读取 | 设置 100 | 读取返回 100 |
| ST-003 | 更新分数 | 先设 100，再设 200 | 读取返回 200 |
| ST-004 | 清除后读取 | 清除 localStorage | 返回 0 |

---

### 2.2 getTheme() / setTheme()

**功能描述**: 主题设置的存储和读取

| 测试用例 ID | 测试场景 | 输入 | 预期结果 |
|------------|---------|------|---------|
| ST-005 | 默认主题 | 无存储数据 | 返回 'candy' |
| ST-006 | 保存主题 | 设置 'mint' | 读取返回 'mint' |
| ST-007 | 切换主题 | 先 'candy' 后 'mint' | 读取返回 'mint' |

---

### 2.3 saveGameState() / getGameState()

**功能描述**: 游戏状态的存储和读取

| 测试用例 ID | 测试场景 | 输入 | 预期结果 |
|------------|---------|------|---------|
| ST-008 | 保存完整状态 | 有效 GameState | 成功保存 |
| ST-009 | 读取保存的状态 | 保存后读取 | 返回相同的状态 |
| ST-010 | 无状态时读取 | 无存储数据 | 返回 null |
| ST-011 | Tile 属性完整性 | 保存带 mergedFrom 的 Tile | 读取后 mergedFrom 存在 |
| ST-012 | 分数持久性 | score=100, bestScore=200 | 读取后值保持不变 |

---

## 三、useGame Hook 测试用例

### 3.1 初始化

| 测试用例 ID | 测试场景 | 预期结果 |
|------------|---------|---------|
| HG-001 | 无保存状态初始化 | 生成两个初始方块，分数为 0 |
| HG-002 | 有保存状态初始化 | 恢复保存的状态 |
| HG-003 | initialized 状态 | 初始化完成后为 true |

---

### 3.2 startNewGame()

| 测试用例 ID | 测试场景 | 预期结果 |
|------------|---------|---------|
| HG-004 | 开始新游戏 | tiles 有 2 个元素，score=0, over=false, won=false |
| HG-005 | 游戏结束后重新开始 | 状态正确重置 |

---

### 3.3 moveTiles()

| 测试用例 ID | 测试场景 | 输入 | 预期结果 |
|------------|---------|------|---------|
| HG-006 | 有效移动 | LEFT | tiles 更新，可能增加分数 |
| HG-007 | 无效移动（游戏结束） | over=true | 不更新状态 |
| HG-008 | 达到 2048 | 移动后产生 2048 方块 | won 变为 true |
| HG-009 | 无法移动时 | 无可移动方块的网格 | over 变为 true |
| HG-010 | 新方块生成 | 每次有效移动后 | tiles 数量增加 1 |

---

## 四、组件测试用例

### 4.1 Tile 组件

| 测试用例 ID | 测试场景 | 输入 | 预期结果 |
|------------|---------|------|---------|
| CP-001 | 渲染基本方块 | value=2 | 显示正确的数字和样式 |
| CP-002 | 不同值的方块 | value=2048 | 显示正确的样式类 |
| CP-003 | 新方块动画 | isNew=true | 添加 new 类 |
| CP-004 | 合并方块 | mergedFrom 存在 | 添加 merged 类 |

---

### 4.2 Board 组件

| 测试用例 ID | 测试场景 | 预期结果 |
|------------|---------|---------|
| CP-005 | 渲染网格 | 显示 16 个背景格子 |
| CP-006 | 渲染方块 | 每个 tile 正确渲染 |
| CP-007 | 键盘事件 | 按下箭头键触发移动 |
| CP-008 | 手势支持 | 滑动触发移动 |

---

### 4.3 ScorePanel 组件

| 测试用例 ID | 测试场景 | 输入 | 预期结果 |
|------------|---------|------|---------|
| CP-009 | 显示分数 | score=100, bestScore=200 | 正确显示两个分数 |
| CP-010 | 分数增加动画 | score 从 100 变为 150 | 添加动画类 |

---

### 4.4 ThemeSwitcher 组件

| 测试用例 ID | 测试场景 | 预期结果 |
|------------|---------|---------|
| CP-011 | 点击切换 | 主题在 candy 和 mint 间切换 |
| CP-012 | 保存偏好 | 切换后保存到 localStorage |

---

## 五、集成测试用例

### 5.1 完整游戏流程

| 测试用例 ID | 测试场景 | 预期结果 |
|------------|---------|---------|
| IT-001 | 从开始到游戏结束 | 能够正常完成整个游戏流程 |
| IT-002 | 状态持久化 | 刷新页面后恢复游戏状态 |
| IT-003 | 达到 2048 | 显示胜利状态 |
| IT-004 | 无法移动时游戏结束 | 正确检测游戏结束 |

---

## 测试覆盖率目标

| 模块 | 目标覆盖率 |
|------|-----------|
| gameLogic.ts | 100% (纯函数，应完全覆盖) |
| storage.ts | 100% |
| useGame.ts | 90%+ |
| 组件 | 80%+ |

---

## 优先级

**P0 (高优先级)**: GL-001 ~ GL-039, ST-001 ~ ST-012
**P1 (中优先级)**: HG-001 ~ HG-010
**P2 (低优先级)**: CP-001 ~ CP-012, IT-001 ~ IT-004
